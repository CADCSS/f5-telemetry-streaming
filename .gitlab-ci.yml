image: quay.pdsea.f5net.com/doc-ops/containthedocs:710e05a8ed

stages:
  - build
  - review
  - deploy

build docs:
  script:
    - make html
  tags:
    - docker-executor
  stage: build
  artifacts:
    paths: 
    - docs/_build/html

# Test docs
test grammar:
  stage: review
  tags:
    - docker-executor
  script:
    - vale --glob='*.{md,rst}' .  

test links:
  stage: review
  tags:
    - docker-executor
  script:
    - make linkcheck

# Deploy docs to Pages for review
pages:
  stage: review
  environment: 
    name: review
    url: https://${CI_PROJECT_NAMESPACE}.pages.gitswarm.f5net.com/${CI_PROJECT_NAME}/$CI_COMMIT_REF_SLUG
  tags:
  - cm-official-docker-executor
  dependencies:
  - build docs  
  script:
  - mkdir -p ./public
  - cp -R docs/_build/html/* ./public
  artifacts:
    paths:
    - public
  only:
  - branches
  except:
  - master@cloudsolutions/f5-telemetry
  - staging@cloudsolutions/f5-telemetry

# Publish ONLY staging branch to clouddocs.f5networks.net.
# Publish docs to staging:
#   stage: deploy
#   environment: 
#     name: staging
#     url: https://clouddocs.f5networks.net/cloud/telemetry/v1
#   tags:
#     - cm-official-docker-executor
#   only:
#     - staging@cloudsolutions/f5-telemetry
#   dependencies:
#     - build docs
#   script:
#     - aws s3 sync docs/_build/html s3://clouddocs.f5networks.net/cloud/telemetry/v1


# Publish ONLY master branch to clouddocs.f5.com
# Publish docs to internet:
#   stage: deploy
#   environment: 
#     name: production
#     url: https://clouddocs.f5.com/cloud/telemetry/v1
#   tags:
#     - cm-official-docker-executor
#   only:
#   - master@cloudsolutions/f5-telemetry
#   dependencies:
#   - build docs
#   script:
#   - publish-cloud-docs-to-prod telemetry v1
  # create invalidation to clear cloudfront cache
#   - aws cloudfront create-invalidation --distribution-id $AWS_DIST --paths /cloud/telemetry/v1/
